{{- define "metrics.container" }}
{{- if .Values.metrics.enabled }}
- name: metrics
  image: {{ .Values.daemon.image.repository }} 
  imagePullPolicy: {{ .Values.daemon.image.pullPolicy }}
  volumeMounts:
  - name: {{ include "k8s-watcher.name" . }}-metrics-config
    mountPath: /etc/telegraf/telegraf.conf
    subPath: telegraf.conf
  resources:
  {{- toYaml .Values.daemon.resources | nindent 4 }}
  envFrom:
  - configMapRef:
      name:  {{ (or .Values.watcher.daemon .Values.watcher.metrics).varsConfigMapName }}
  env:
  {{- if .Values.proxy.http }}
  - name: KOMOKW_HTTP_PROXY_URL
    value: {{ .Values.proxy.http }}
  {{- end }}
  {{- if .Values.proxy.https }}
  - name: KOMOKW_HTTPS_PROXY_URL
    value: {{ .Values.proxy.https }}
  {{- end }}
  {{- if .Values.watcher.clusterName }}
  - name: CLUSTER_NAME
    value: {{ .Values.watcher.clusterName }}
  {{- end }}
{{- end }}
{{- end }}

{{- define "metrics.deploy.volumes" }}
{{- if and .Values.metrics (.Values.metrics.enabled | default false) }}
- name: {{ include "k8s-watcher.name" . }}-metrics-config
  configMap:
    name: {{ include "k8s-watcher.name" . }}-metrics-config
{{- end }}
{{- end }}